#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative "../config/environment"
require "socket"
require "base64"

PORT = 5683
MAX_PACKET_SIZE = 2048

socket = UDPSocket.new
socket.bind("0.0.0.0", PORT)

Rails.logger.info "üå≥ [Sanctum] UDP/CoAP –°–ª—É—Ö–∞—á –∑–∞–ø—É—â–µ–Ω–æ –Ω–∞ –ø–æ—Ä—Ç—É #{PORT}. –¢–µ—Ä—Ç—è –≤—ñ–¥—Å—É—Ç–Ω—î."

loop do
  begin
    # 1. –õ–æ–≤–∏–º–æ –ø–∞–∫–µ—Ç (–±–ª–æ–∫—É—î—Ç—å—Å—è –¥–æ –ø–æ—è–≤–∏ –¥–∞–Ω–∏—Ö)
    data, sender = socket.recvfrom(MAX_PACKET_SIZE)

    # 2. –ú—ñ–∫—Ä–æ-–ø–∞—Ä—Å–µ—Ä CoAP
    header = data.unpack("CCn")
    type = (header[0] >> 4) & 0x03

    # 3. –ú–∏—Ç—Ç—î–≤–∏–π ACK (—è–∫—â–æ –ø–∞–∫–µ—Ç Confirmable)
    if type == 0
      ack_packet = [ 0x60, 0x44, header[2] ].pack("CCn")
      socket.send(ack_packet, 0, sender[3], sender[1])
    end

    # 4. –í–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è –∫–æ—Ä–∏—Å–Ω–æ–≥–æ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
    payload_marker_index = data.index("\xFF".b)
    if payload_marker_index
      binary_payload = data[(payload_marker_index + 1)..-1]

      # 5. MAX SPEED: –ö–æ–¥—É—î–º–æ –±—ñ–Ω–∞—Ä–Ω–∏–∫ —É —Ç–µ–∫—Å—Ç —ñ –∫–∏–¥–∞—î–º–æ –≤ Redis (Sidekiq)
      # strict_encode64 –Ω–µ –¥–æ–¥–∞—î —Å–∏–º–≤–æ–ª—ñ–≤ –ø–µ—Ä–µ–Ω–æ—Å—É —Ä—è–¥–∫–∞ (\n), —â–æ —Ä–æ–±–∏—Ç—å –π–æ–≥–æ —â–µ —à–≤–∏–¥—à–∏–º
      encoded_payload = Base64.strict_encode64(binary_payload)

      # –ú–∏—Ç—Ç—î–≤–∏–π –∑–∞–ø–∏—Å –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—É –ø–∞–º'—è—Ç—å (O(1))
      UnpackTelemetryWorker.perform_async(encoded_payload, sender[3])
    end

  rescue StandardError => e
    # –Ñ–¥–∏–Ω–∏–π –ª–æ–≥, —è–∫–∏–π –Ω–∞–º –ø–æ—Ç—Ä—ñ–±–µ–Ω ‚Äî —Ü–µ –ª–æ–≥ —Ñ–∞—Ç–∞–ª—å–Ω–æ—ó –ø–æ–º–∏–ª–∫–∏
    Rails.logger.error "üõë Crash: #{e.message}"
  end
end
