#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative "../config/environment"
require "socket"
require "base64"

# –ü–æ—Ä—Ç –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –¥–ª—è CoAP
PORT = 5683
MAX_PACKET_SIZE = 2048

socket = UDPSocket.new
socket.bind("0.0.0.0", PORT)

Rails.logger.info "üå≥ [Sanctum] UDP/CoAP –ë—Ä–∞–º–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∞ –Ω–∞ –ø–æ—Ä—Ç—É #{PORT}. –°–ª—É—Ö–∞—î–º–æ –¥–∏—Ö–∞–Ω–Ω—è –ª—ñ—Å—É..."

# –ü–†–û–¢–û–ö–û–õ –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –ó–ê–í–ï–†–®–ï–ù–ù–Ø
running = true
%w[INT TERM].each do |signal|
  trap(signal) do
    Rails.logger.info "üõë [Sanctum] –û—Ç—Ä–∏–º–∞–Ω–æ —Å–∏–≥–Ω–∞–ª #{signal}. –ï—Ñ—ñ—Ä –∑–∞–∫—Ä–∏–≤–∞—î—Ç—å—Å—è..."
    running = false
  end
end

while running
  begin
    # –û—á—ñ–∫—É—î–º–æ –¥–∞–Ω—ñ (—Ç–∞–π–º–∞—É—Ç 1—Å –¥–ª—è –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –≤–∏—Ö–æ–¥—É)
    if IO.select([socket], nil, nil, 1)
      data, sender = socket.recvfrom_nonblock(MAX_PACKET_SIZE)
      gateway_ip = sender[3]

      # 1. –ü–ê–†–°–ï–† –ó–ê–ì–û–õ–û–í–ö–ê CoAP (RFC 7252)
      # [Ver:2][T:2][TKL:4] | [Code:8] | [Message ID:16]
      header = data.unpack("CCn")
      first_byte = header[0]
      type = (first_byte >> 4) & 0x03 # 0: CON, 1: NON, 2: ACK, 3: RST
      tkl  = first_byte & 0x0F        # Token Length
      code = header[1]                # Method/Response Code
      msg_id = header[2]

      # 2. –ú–ò–¢–¢–Ñ–í–ò–ô ACK (–î–ª—è Confirmable –ø–∞–∫–µ—Ç—ñ–≤)
      # –Ø–∫—â–æ –ö–æ—Ä–æ–ª–µ–≤–∞ —Ö–æ—á–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è (Type 0), –º–∏ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ ACK (Type 2)
      if type == 0
        # 0x44 = 2.04 Changed (–£—Å–ø—ñ—à–Ω–∏–π PUT)
        # –§–æ—Ä–º—É—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ ACK –∑ —Ç–∏–º —Å–∞–º–∏–º Token Length —Ç–∞ Message ID
        ack_header = [(1 << 6) | (2 << 4) | tkl, 0x44, msg_id].pack("CCn")
        # –î–æ–¥–∞—î–º–æ —Ç–æ–∫–µ–Ω, —è–∫—â–æ –≤—ñ–Ω –±—É–≤ —É –≤—Ö—ñ–¥–Ω–æ–º—É –ø–∞–∫–µ—Ç—ñ
        token = tkl > 0 ? data[4...(4 + tkl)] : "".b
        socket.send(ack_header + token, 0, gateway_ip, sender[1])
      end

      # 3. –ü–û–®–£–ö –ü–ï–ô–õ–û–ê–î–ê
      # –®—É–∫–∞—î–º–æ –º–∞—Ä–∫–µ—Ä 0xFF, —è–∫–∏–π –≤—ñ–¥–æ–∫—Ä–µ–º–ª—é—î –æ–ø—Ü—ñ—ó –≤—ñ–¥ —Ç—ñ–ª–∞
      payload_marker_index = data.index("\xFF".b)
      
      if payload_marker_index
        binary_payload = data[(payload_marker_index + 1)..-1]
        
        # 4. –ú–ê–†–®–†–£–¢–ò–ó–ê–¶–Ü–Ø (Uri-Path –∞–Ω–∞–ª—ñ–∑)
        # –û–ø—Ü—ñ—ó Uri-Path –º–∞—é—Ç—å –Ω–æ–º–µ—Ä 11. –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –±–ª–æ–∫ –æ–ø—Ü—ñ–π.
        options_block = data[(4 + tkl)...payload_marker_index]
        
        # [–°–ò–ù–•–†–û–ù–Ü–ó–ê–¶–Ü–Ø]: –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —à–ª—è—Ö, —è–∫–∏–π –∑–∞–∫–ª–∞–¥–µ–Ω–∏–π —É –ø—Ä–æ—à–∏–≤–∫—É main.c
        if options_block.include?("telemetry") && options_block.include?("batch")
          # –ö–æ–¥—É—î–º–æ –≤ Base64 –¥–ª—è –±–µ–∑–ø–µ—á–Ω–æ—ó –ø–µ—Ä–µ–¥–∞—á—ñ –≤ Redis/Sidekiq
          encoded_payload = Base64.strict_encode64(binary_payload)

          # –ü–µ—Ä–µ–¥–∞—î–º–æ IP-–∞–¥—Ä–µ—Å—É —è–∫ "–º–µ—Ä–µ–∂–µ–≤–∏–π —è–∫—ñ—Ä" –¥–ª—è —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –ö–æ—Ä–æ–ª–µ–≤–∏
          UnpackTelemetryWorker.perform_async(encoded_payload, gateway_ip)
          
          Rails.logger.debug "üõ∞Ô∏è [Sanctum] –ë–∞—Ç—á –≤—ñ–¥ #{gateway_ip} –ø—Ä–∏–π–Ω—è—Ç–æ. –î–æ–≤–∂–∏–Ω–∞: #{binary_payload.bytesize}–±."
        else
          Rails.logger.debug "‚ö†Ô∏è [Sanctum] –ü–∞–∫–µ—Ç –≤—ñ–¥ #{gateway_ip} –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ: –Ω–µ–≤—ñ–¥–æ–º–∏–π –º–∞—Ä—à—Ä—É—Ç."
        end
      end
    end
  rescue Errno::EAGAIN, Errno::EWOULDBLOCK
    retry
  rescue StandardError => e
    Rails.logger.error "üõë [Sanctum] –ó–±—ñ–π —É –º–∞—Ç—Ä–∏—Ü—ñ: #{e.message}"
  end
end

socket.close
Rails.logger.info "üå≥ [Sanctum] –°–ª—É—Ö–∞—á –∑—É–ø–∏–Ω–µ–Ω–æ. –ü–æ—Å—É–¥–∏–Ω–∞ –ø–æ—Ä–æ–∂–Ω—è."
