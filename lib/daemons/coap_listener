#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative "../../config/environment"
require "socket"
require "base64"

PORT = 5683
MAX_PACKET_SIZE = 2048

socket = UDPSocket.new
socket.bind("0.0.0.0", PORT)

Rails.logger.info "üå≥ [Sanctum] UDP/CoAP –ë—Ä–∞–º–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∞ –Ω–∞ –ø–æ—Ä—Ç—É #{PORT}. –°–ª—É—Ö–∞—î–º–æ –¥–∏—Ö–∞–Ω–Ω—è –ª—ñ—Å—É..."

# –ü–†–û–¢–û–ö–û–õ –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –ó–ê–í–ï–†–®–ï–ù–ù–Ø (Graceful Shutdown)
running = true
%w[INT TERM].each do |signal|
  trap(signal) do
    Rails.logger.info "üõë [Sanctum] –û—Ç—Ä–∏–º–∞–Ω–æ —Å–∏–≥–Ω–∞–ª #{signal}. –ï—Ñ—ñ—Ä –∑–∞–∫—Ä–∏–≤–∞—î—Ç—å—Å—è..."
    running = false
  end
end

while running
  begin
    if IO.select([socket], nil, nil, 1)
      data, sender = socket.recvfrom_nonblock(MAX_PACKET_SIZE)
      gateway_ip = sender[3]

      # 1. –ú—ñ–∫—Ä–æ-–ø–∞—Ä—Å–µ—Ä CoAP (–†–æ–∑–±–∏—Ä–∞—î–º–æ 4 –±–∞–π—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞)
      header = data.unpack("CCn")
      version = header[0] >> 6
      type = (header[0] >> 4) & 0x03
      tkl = header[0] & 0x0F
      code = header[1]
      msg_id = header[2]

      # 2. –ú–ò–¢–¢–Ñ–í–ò–ô ACK (–Ø–∫—â–æ –º–æ–¥–µ–º SIM7070G –Ω–∞–¥—ñ—Å–ª–∞–≤ Confirmable –ø–∞–∫–µ—Ç)
      if type == 0
        # –§–æ—Ä–º—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å: Type 2 (ACK), Code 0x44 (2.04 Changed)
        ack_header = [ (1 << 6) | (2 << 4) | tkl, 0x44, msg_id ].pack("CCn")
        # –Ø–∫—â–æ –±—É–≤ Token, –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ –π–æ–≥–æ
        ack_packet = ack_header + (tkl > 0 ? data[4...(4+tkl)] : "".b)
        socket.send(ack_packet, 0, gateway_ip, sender[1])
      end

      # 3. –í–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è –∫–æ—Ä–∏—Å–Ω–æ–≥–æ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
      payload_marker_index = data.index("\xFF".b)
      if payload_marker_index
        binary_payload = data[(payload_marker_index + 1)..-1]

        # 4. –ú–ê–†–®–†–£–¢–ò–ó–ê–¶–Ü–Ø (–ß–∏—Ç–∞—î–º–æ Uri-Options)
        # –û–ø—Ü—ñ—ó –∑–Ω–∞—Ö–æ–¥—è—Ç—å—Å—è –º—ñ–∂ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º (—ñ —Ç–æ–∫–µ–Ω–æ–º) —Ç–∞ –º–∞—Ä–∫–µ—Ä–æ–º 0xFF
        options_block = data[(4+tkl)...payload_marker_index]
        
        # –®–≤–∏–¥–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ —Ü–µ —à–ª—è—Ö "telemetry/batch"
        if options_block.include?("telemetry") && options_block.include?("batch")
          # –ö–æ–¥—É—î–º–æ –≤ Base64 –¥–ª—è –±–µ–∑–ø–µ—á–Ω–æ—ó –ø–æ–¥–æ—Ä–æ–∂—ñ —á–µ—Ä–µ–∑ Redis
          encoded_payload = Base64.strict_encode64(binary_payload)

          # –ü–µ—Ä–µ–¥–∞—î–º–æ IP-–∞–¥—Ä–µ—Å—É, —â–æ–± –≤–æ—Ä–∫–µ—Ä –º—ñ–≥ –∑–Ω–∞–π—Ç–∏ —à–ª—é–∑ (–ö–æ—Ä–æ–ª–µ–≤—É) —É –±–∞–∑—ñ
          UnpackTelemetryWorker.perform_async(encoded_payload, gateway_ip)
        else
          Rails.logger.debug "‚ö†Ô∏è [Sanctum] –ù–µ–≤—ñ–¥–æ–º–∏–π CoAP –º–∞—Ä—à—Ä—É—Ç –≤—ñ–¥ #{gateway_ip}"
        end
      end
    end
  rescue Errno::EAGAIN, Errno::EWOULDBLOCK
    retry
  rescue StandardError => e
    Rails.logger.error "üõë [Sanctum] –ó–±—ñ–π —É –º–∞—Ç—Ä–∏—Ü—ñ: #{e.message}"
  end
end

socket.close
Rails.logger.info "üå≥ [Sanctum] –°–ª—É—Ö–∞—á —É—Å–ø—ñ—à–Ω–æ –∑—É–ø–∏–Ω–µ–Ω–æ. –ü–æ—Å—É–¥–∏–Ω–∞ –∑–∞–∫—Ä–∏—Ç–∞."
