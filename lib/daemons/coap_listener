#!/usr/bin/env ruby
# frozen_string_literal: true

# ĞÑĞºÑ–Ğ»ÑŒĞºĞ¸ Ñ„Ğ°Ğ¹Ğ» Ğ»ĞµĞ¶Ğ¸Ñ‚ÑŒ Ñƒ lib/daemons/, Ğ¼Ğ¸ Ğ¿Ñ–Ğ´Ğ½Ñ–Ğ¼Ğ°Ñ”Ğ¼Ğ¾ÑÑ Ğ½Ğ° Ğ´Ğ²Ğ° Ñ€Ñ–Ğ²Ğ½Ñ– Ğ²Ğ³Ğ¾Ñ€Ñƒ
require_relative "../../config/environment"
require "socket"
require "base64"

PORT = 5683
MAX_PACKET_SIZE = 2048

socket = UDPSocket.new
socket.bind("0.0.0.0", PORT)

Rails.logger.info "ğŸŒ³ [Sanctum] UDP/CoAP Ğ¡Ğ»ÑƒÑ…Ğ°Ñ‡ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ğ¾ Ğ½Ğ° Ğ¿Ğ¾Ñ€Ñ‚Ñƒ #{PORT}. Ğ¢ĞµÑ€Ñ‚Ñ Ğ²Ñ–Ğ´ÑÑƒÑ‚Ğ½Ñ”."

# ĞŸĞ ĞĞ¢ĞĞšĞĞ› ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ¬ĞĞĞ“Ğ Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•ĞĞĞ¯ (Graceful Shutdown)
running = true
%w[INT TERM].each do |signal|
  trap(signal) do
    Rails.logger.info "ğŸ›‘ [Sanctum] ĞÑ‚Ñ€Ğ¸Ğ¼Ğ°Ğ½Ğ¾ ÑĞ¸Ğ³Ğ½Ğ°Ğ» #{signal}. Ğ—Ğ°ĞºÑ€Ğ¸Ğ²Ğ°Ñ”Ğ¼Ğ¾ ĞµÑ„Ñ–Ñ€..."
    running = false
  end
end

while running
  begin
    # Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ IO.select Ğ· Ñ‚Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚Ğ¾Ğ¼ 1 ÑĞµĞºÑƒĞ½Ğ´Ğ°. 
    # Ğ¦Ğµ Ğ´Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑÑ” Ñ†Ğ¸ĞºĞ»Ñƒ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ‚Ğ¸ Ğ·Ğ¼Ñ–Ğ½Ğ½Ñƒ `running` Ñ– Ğ·ÑƒĞ¿Ğ¸Ğ½ÑÑ‚Ğ¸ÑÑ Ğ±ĞµĞ· Ğ·Ğ°Ğ²Ğ¸ÑĞ°Ğ½Ğ½Ñ.
    if IO.select([socket], nil, nil, 1)
      data, sender = socket.recvfrom_nonblock(MAX_PACKET_SIZE)

      # 1. ĞœÑ–ĞºÑ€Ğ¾-Ğ¿Ğ°Ñ€ÑĞµÑ€ CoAP
      header = data.unpack("CCn")
      type = (header[0] >> 4) & 0x03

      # 2. ĞœĞ¸Ñ‚Ñ‚Ñ”Ğ²Ğ¸Ğ¹ ACK (ÑĞºÑ‰Ğ¾ Ğ¿Ğ°ĞºĞµÑ‚ Confirmable)
      if type == 0
        ack_packet = [ 0x60, 0x44, header[2] ].pack("CCn")
        socket.send(ack_packet, 0, sender[3], sender[1])
      end

      # 3. Ğ’Ğ¸Ñ‚ÑĞ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ ĞºĞ¾Ñ€Ğ¸ÑĞ½Ğ¾Ğ³Ğ¾ Ğ½Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ
      payload_marker_index = data.index("\xFF".b)
      if payload_marker_index
        binary_payload = data[(payload_marker_index + 1)..-1]

        # 4. MAX SPEED: ĞšĞ¾Ğ´ÑƒÑ”Ğ¼Ğ¾ Ğ±Ñ–Ğ½Ğ°Ñ€Ğ½Ğ¸Ğº Ñƒ Ñ‚ĞµĞºÑÑ‚ Ñ– ĞºĞ¸Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ² Redis (Sidekiq)
        encoded_payload = Base64.strict_encode64(binary_payload)

        # ĞœĞ¸Ñ‚Ñ‚Ñ”Ğ²Ğ¸Ğ¹ Ğ·Ğ°Ğ¿Ğ¸Ñ Ğ² Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñƒ Ğ¿Ğ°Ğ¼'ÑÑ‚ÑŒ (O(1))
        UnpackTelemetryWorker.perform_async(encoded_payload, sender[3])
      end
    end
  rescue Errno::EAGAIN, Errno::EWOULDBLOCK
    # Ğ¦Ñ– Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºĞ¸ Ñ” Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¼Ğ¸ Ğ´Ğ»Ñ nonblock ÑĞ¾ĞºĞµÑ‚Ñ–Ğ², Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ñ–Ğ³Ğ½Ğ¾Ñ€ÑƒÑ”Ğ¼Ğ¾ Ñ– Ğ¹Ğ´ĞµĞ¼Ğ¾ Ğ½Ğ° Ğ½Ğ°ÑÑ‚ÑƒĞ¿Ğ½Ğµ ĞºĞ¾Ğ»Ğ¾
    retry
  rescue StandardError => e
    Rails.logger.error "ğŸ›‘ [Sanctum] Crash: #{e.message}"
  end
end

socket.close
Rails.logger.info "ğŸŒ³ [Sanctum] Ğ¡Ğ»ÑƒÑ…Ğ°Ñ‡ ÑƒÑĞ¿Ñ–ÑˆĞ½Ğ¾ Ğ·ÑƒĞ¿Ğ¸Ğ½ĞµĞ½Ğ¾. ĞŸĞ¾ÑÑƒĞ´Ğ¸Ğ½Ğ° Ğ·Ğ°ĞºÑ€Ğ¸Ñ‚Ğ°."
