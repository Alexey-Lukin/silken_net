#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative "../../config/environment"
require "socket"
require "base64"

# –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è Kamal/Docker –ª–æ–≥—ñ–≤
$stdout.sync = true

# –ü–æ—Ä—Ç –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –¥–ª—è CoAP
PORT = ENV.fetch("COAP_PORT", 5683).to_i
MAX_PACKET_SIZE = 2048

socket = UDPSocket.new
socket.bind("0.0.0.0", PORT)

Rails.logger.info "üå≥ [Sanctum] UDP/CoAP –ë—Ä–∞–º–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∞ –Ω–∞ –ø–æ—Ä—Ç—É #{PORT}. –°–ª—É—Ö–∞—î–º–æ –¥–∏—Ö–∞–Ω–Ω—è –ª—ñ—Å—É..."
puts "üõ∞Ô∏è  –°–∏—Å—Ç–µ–º–∞ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É –µ—Ñ—ñ—Ä—É –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–∞. –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –ø–∞–∫–µ—Ç—ñ–≤..."

# --- –¢–ò–¢–ê–ù–û–í–ò–ô –ü–ê–†–°–ï–† –û–ü–¶–Ü–ô (RFC 7252) ---
def decode_options(buffer)
  options = []
  current_option_number = 0
  cursor = 0

  while cursor < buffer.bytesize
    first_byte = buffer.getbyte(cursor)
    cursor += 1
    
    delta = (first_byte >> 4) & 0x0F
    length = first_byte & 0x0F

    # –û–±—Ä–æ–±–∫–∞ —Ä–æ–∑—à–∏—Ä–µ–Ω–æ—ó –¥–µ–ª—å—Ç–∏ (–∫–æ–¥ 13: +1 –±–∞–π—Ç)
    if delta == 13
      delta = buffer.getbyte(cursor) + 13
      cursor += 1
    end

    # –û–±—Ä–æ–±–∫–∞ —Ä–æ–∑—à–∏—Ä–µ–Ω–æ—ó –¥–æ–≤–∂–∏–Ω–∏ (–∫–æ–¥ 13: +1 –±–∞–π—Ç)
    if length == 13
      length = buffer.getbyte(cursor) + 13
      cursor += 1
    end

    current_option_number += delta
    value = buffer.byteslice(cursor, length)
    cursor += length

    options << { number: current_option_number, value: value }
  end
  options
end

# –ü–†–û–¢–û–ö–û–õ –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –ó–ê–í–ï–†–®–ï–ù–ù–Ø
running = true
%w[INT TERM].each do |signal|
  trap(signal) do
    puts "\nüõë [Sanctum] –û—Ç—Ä–∏–º–∞–Ω–æ —Å–∏–≥–Ω–∞–ª #{signal}. –ï—Ñ—ñ—Ä –∑–∞–∫—Ä–∏–≤–∞—î—Ç—å—Å—è..."
    running = false
  end
end

while running
  begin
    if IO.select([ socket ], nil, nil, 1)
      data, sender = socket.recvfrom_nonblock(MAX_PACKET_SIZE)
      gateway_ip = sender[3]
      timestamp = Time.current

      # 0. –ñ–ò–í–ò–ô –ü–û–¢–Ü–ö –£ –ú–ê–¢–†–ò–¶–Æ (ActionCable)
      # –¢—Ä–∞–Ω—Å–ª—é—î–º–æ "—Å–∏—Ä—ñ" –±–∞–π—Ç–∏ –≤ –≥–µ–∫—Å–∞–¥–µ—Ü–∏–º–∞–ª—å–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—ñ –¥–ª—è UI
      ActionCable.server.broadcast("telemetry_live_stream", {
        hex: data.unpack1("H*").scan(/../).join(" "),
        ip: gateway_ip,
        size: data.bytesize,
        at: timestamp.strftime("%H:%M:%S.%L")
      })

      # 1. –ü–ê–†–°–ï–† –ó–ê–ì–û–õ–û–í–ö–ê CoAP
      header = data.unpack("CCn")
      first_byte = header[0]
      type = (first_byte >> 4) & 0x03
      tkl  = first_byte & 0x0F
      code = header[1]
      msg_id = header[2]

      # 2. –ú–ò–¢–¢–Ñ–í–ò–ô ACK (Confirmable Flow)
      if type == 0
        ack_header = [ (1 << 6) | (2 << 4) | tkl, 0x44, msg_id ].pack("CCn")
        token = tkl > 0 ? data[4...(4 + tkl)] : "".b
        socket.send(ack_header + token, 0, gateway_ip, sender[1])
      end

      # 3. –ü–û–®–£–ö –ü–ï–ô–õ–û–ê–î–ê
      payload_marker_index = data.index("\xFF".b)

      if payload_marker_index
        binary_payload = data[(payload_marker_index + 1)..-1]
        options_block = data[(4 + tkl)...payload_marker_index]
        
        parsed_options = decode_options(options_block)
        path_segments = parsed_options.select { |o| o[:number] == 11 }.map { |o| o[:value] }

        if path_segments == ["telemetry", "batch"]
          # 4. –°–ò–ù–•–†–û–ù–Ü–ó–ê–¶–Ü–Ø –ó –ë–ê–ó–û–Æ –¢–ê sidekiq
          ActiveRecord::Base.connection.verify! unless ActiveRecord::Base.connected?
          
          encoded_payload = Base64.strict_encode64(binary_payload)
          UnpackTelemetryWorker.perform_async(encoded_payload, gateway_ip)

          puts "üì• [#{timestamp.strftime('%T')}] –ü–∞–∫–µ—Ç –≤—ñ–¥ #{gateway_ip} –ø—Ä–∏–π–Ω—è—Ç–æ (#{binary_payload.bytesize}–±)"
        else
          puts "‚ö†Ô∏è  [#{timestamp.strftime('%T')}] –í—ñ–¥—Ö–∏–ª–µ–Ω–æ: –Ω–µ–≤—ñ–¥–æ–º–∏–π –º–∞—Ä—à—Ä—É—Ç #{path_segments.join('/')}"
        end
      end
    end
  rescue Errno::EAGAIN, Errno::EWOULDBLOCK
    retry
  rescue StandardError => e
    puts "üõë [Sanctum Error] #{e.message}"
    Rails.logger.error "üõë [Sanctum] –ó–±—ñ–π —É –º–∞—Ç—Ä–∏—Ü—ñ: #{e.message}\n#{e.backtrace.first(3).join("\n")}"
  end
end

socket.close
puts "üîí [Sanctum] –ë—Ä–∞–º–∞ –∑–∞–∫—Ä–∏—Ç–∞. –ï—Ñ—ñ—Ä –º–æ–≤—á–∏—Ç—å."
