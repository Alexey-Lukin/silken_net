# frozen_string_literal: true

class DailyAggregationWorker
  include Sidekiq::Job
  
  # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –Ω–∏–∑—å–∫–∏–π –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç, –∞–ª–µ –æ–±–º–µ–∂—É—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–µ—Ç—Ä–∞—ó–≤.
  # lock: :until_executed –∑–∞–ø–æ–±—ñ–≥–∞—î –æ–¥–Ω–æ—á–∞—Å–Ω–æ–º—É –∑–∞–ø—É—Å–∫—É –∑–∞ —Ç—É —Å–∞–º—É –¥–∞—Ç—É.
  sidekiq_options queue: "low", retry: 3, lock: :until_executed

  def perform(date_string = nil)
    # 1. –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Ü—ñ–ª—å–æ–≤–æ—ó –¥–∞—Ç–∏ (–∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –∑–æ–Ω–∏ –ø—Ä–æ–µ–∫—Ç—É)
    # –ü–æ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—é –±–µ—Ä–µ–º–æ –≤—á–æ—Ä–∞—à–Ω—ñ–π –¥–µ–Ω—å —É —á–∞—Å–æ–≤–æ–º—É –ø–æ—è—Å—ñ –ö–∏—î–≤–∞
    target_date = if date_string
                    Date.parse(date_string)
                  else
                    Time.use_zone("Kyiv") { Date.yesterday }
                  end

    Rails.logger.info "üïí [–•—Ä–æ–Ω–æ–º–µ—Ç—Ä–∏—Å—Ç] –ü–æ—á–∞—Ç–æ–∫ –≤–µ–ª–∏–∫–æ—ó –∞–≥—Ä–µ–≥–∞—Ü—ñ—ó –∑–∞ #{target_date}..."

    # 2. –í–∏–∫–ª–∏–∫ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ —ñ–Ω—Å–∞–π—Ç—ñ–≤ (–°—Ç–∏—Å–Ω–µ–Ω–Ω—è —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—ñ)
    # –ú–∏ –æ–±–≥–æ—Ä—Ç–∞—î–º–æ —Ü–µ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é –Ω–∞ —Ä—ñ–≤–Ω—ñ —Å–µ—Ä–≤—ñ—Å—É, 
    # –∞–ª–µ —Ç—É—Ç —Ñ—ñ–∫—Å—É—î–º–æ –∑–∞–≥–∞–ª—å–Ω–∏–π —Å—Ç–∞—Ç—É—Å.
    InsightGeneratorService.call(target_date)

    # 3. –ó–ê–ú–ö–ù–ï–ù–ò–ô –¶–ò–ö–õ (The Chaining)
    # –û–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ—ó –∞–≥—Ä–µ–≥–∞—Ü—ñ—ó –º–∏ –ø–æ–≤–∏–Ω–Ω—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ NaaS –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∏.
    # –¶–µ –≥–∞—Ä–∞–Ω—Ç—É—î, —â–æ Slashing Protocol –ø—Ä–∞—Ü—é—î –Ω–∞ —Å–≤—ñ–∂–∏—Ö –¥–∞–Ω–∏—Ö.
    ClusterHealthCheckWorker.perform_async

    Rails.logger.info "‚úÖ [–•—Ä–æ–Ω–æ–º–µ—Ç—Ä–∏—Å—Ç] –ê–≥—Ä–µ–≥–∞—Ü—ñ—è —Ç–∞ –∞—É–¥–∏—Ç –∑–∞ #{target_date} —É—Å–ø—ñ—à–Ω–æ –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω—ñ."

  rescue Date::Error => e
    Rails.logger.error "üõë [–•—Ä–æ–Ω–æ–º–µ—Ç—Ä–∏—Å—Ç] –ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç–∏: #{date_string}"
  rescue StandardError => e
    Rails.logger.error "üõë [–•—Ä–æ–Ω–æ–º–µ—Ç—Ä–∏—Å—Ç] –ö—Ä–∏—Ç–∏—á–Ω–∏–π –∑–±—ñ–π —Ü–∏–∫–ª—É –∞–≥—Ä–µ–≥–∞—Ü—ñ—ó: #{e.message}"
    raise e
  end
end
