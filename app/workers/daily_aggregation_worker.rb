# frozen_string_literal: true

class DailyAggregationWorker
  include Sidekiq::Job
  
  # –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç "low" –¥–ª—è —Ñ–æ–Ω–æ–≤–∏—Ö –∑–∞–¥–∞—á, –∞–ª–µ —Å—É–≤–æ—Ä–∞ —É–Ω—ñ–∫–∞–ª—å–Ω—ñ—Å—Ç—å –∑–∞ –¥–∞—Ç–æ—é.
  # lock: :until_executed –≥–∞—Ä–∞–Ω—Ç—É—î, —â–æ –º–∏ –Ω–µ –ø–æ—á–Ω–µ–º–æ "—Å—Ç–∏—Å–∫–∞—Ç–∏" —Ç–æ–π —Å–∞–º–∏–π –¥–µ–Ω—å –¥–≤—ñ—á—ñ.
  sidekiq_options queue: "low", retry: 3, lock: :until_executed

  def perform(date_string = nil)
    # 1. –í–ò–ó–ù–ê–ß–ï–ù–ù–Ø –¶–Ü–õ–¨–û–í–û–á –î–ê–¢–ò (The Project Pulse)
    target_date = if date_string.present?
                    Date.parse(date_string)
                  else
                    Time.use_zone("Kyiv") { Date.yesterday }
                  end

    Rails.logger.info "üïí [–•—Ä–æ–Ω–æ–º–µ—Ç—Ä–∏—Å—Ç] –ü–æ—á–∞—Ç–æ–∫ –≤–µ–ª–∏–∫–æ—ó –∞–≥—Ä–µ–≥–∞—Ü—ñ—ó –∑–∞ #{target_date}..."

    # 2. –°–¢–ò–°–ù–ï–ù–ù–Ø –†–ï–ê–õ–¨–ù–û–°–¢–Ü (Insight Generation)
    # –¶–µ–π —Å–µ—Ä–≤—ñ—Å –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î –º—ñ–ª—å–π–æ–Ω–∏ –ª–æ–≥—ñ–≤ —Ç–µ–ª–µ–º–µ—Ç—Ä—ñ—ó –Ω–∞ –¥–æ–±–æ–≤—ñ –∑–≤—ñ—Ç–∏ AiInsight.
    # –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–µ—Ä–≤—ñ—Å—É (—É—Å–ø—ñ—Ö/–∫—ñ–ª—å–∫—ñ—Å—Ç—å) –¥–æ–ø–æ–º–æ–∂–µ –Ω–∞–º –∑—Ä–æ–∑—É–º—ñ—Ç–∏, —á–∏ –π—Ç–∏ –¥–∞–ª—ñ.
    aggregation_results = InsightGeneratorService.call(target_date)

    if aggregation_results[:processed_count].to_i.positive?
      # 3. –ó–ê–ú–ö–ù–ï–ù–ò–ô –¶–ò–ö–õ (The Chaining)
      # [–°–ò–ù–•–†–û–ù–Ü–ó–û–í–ê–ù–û]: –ü–µ—Ä–µ–¥–∞—î–º–æ –¥–∞—Ç—É –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É –≤–æ—Ä–∫–µ—Ä—É.
      # –¶–µ –≥–∞—Ä–∞–Ω—Ç—É—î, —â–æ Slashing Protocol —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ñ–≤
      # –≤—ñ–¥–±—É–¥—É—Ç—å—Å—è —Å–∞–º–µ –¥–ª—è —Ç–∏—Ö –¥–∞–Ω–∏—Ö, —è–∫—ñ –º–∏ —â–æ–π–Ω–æ –∑–≥–µ–Ω–µ—Ä—É–≤–∞–ª–∏.
      ClusterHealthCheckWorker.perform_async(target_date.to_s)
      
      # –¢–∞–∫–æ–∂ –≤–∞—Ä—Ç–æ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏—á–Ω–µ —Å—Ç—Ä–∞—Ö—É–≤–∞–Ω–Ω—è
      # ParametricInsuranceWorker.perform_async(target_date.to_s)

      Rails.logger.info "‚úÖ [–•—Ä–æ–Ω–æ–º–µ—Ç—Ä–∏—Å—Ç] –ê–≥—Ä–µ–≥–∞—Ü—ñ—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (#{aggregation_results[:processed_count]} –≤—É–∑–ª—ñ–≤). –ê—É–¥–∏—Ç –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ñ–≤ –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ."
    else
      Rails.logger.warn "‚ö†Ô∏è [–•—Ä–æ–Ω–æ–º–µ—Ç—Ä–∏—Å—Ç] –ó–∞ #{target_date} –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –¥–∞–Ω–∏—Ö –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü—ñ—ó. –õ–∞–Ω—Ü—é–≥ –∞—É–¥–∏—Ç—É –∑—É–ø–∏–Ω–µ–Ω–æ."
    end

  rescue Date::Error => e
    Rails.logger.error "üõë [–•—Ä–æ–Ω–æ–º–µ—Ç—Ä–∏—Å—Ç] –ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç–∏: #{date_string}"
  rescue StandardError => e
    # –ú–∏ –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ raise —Ç—É—Ç, —è–∫—â–æ –Ω–µ —Ö–æ—á–µ–º–æ, —â–æ–± Sidekiq –Ω–µ—Å–∫—ñ–Ω—á–µ–Ω–Ω–æ 
    # –Ω–∞–º–∞–≥–∞–≤—Å—è –ø–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏ –¥–µ–Ω—å, —è–∫–∏–π "–∑–ª–∞–º–∞–≤—Å—è" (–∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –ø–æ–ª—ñ—Ç–∏–∫–∏ —Ä–µ—Ç—Ä–∞—ó–≤).
    # –ê–ª–µ –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö –∑–±–æ—ó–≤ ‚Äî raise –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏–π.
    Rails.logger.error "üõë [–•—Ä–æ–Ω–æ–º–µ—Ç—Ä–∏—Å—Ç] –ö—Ä–∏—Ç–∏—á–Ω–∏–π –∑–±—ñ–π —Ü–∏–∫–ª—É –∞–≥—Ä–µ–≥–∞—Ü—ñ—ó: #{e.message}"
    raise e
  end
end
