# frozen_string_literal: true

class TokenomicsEvaluatorWorker
  include Sidekiq::Job
  # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É —á–µ—Ä–≥—É, –∑–∞–ø—É—Å–∫–∞—Ç–∏–º–µ—Ç—å—Å—è –ø–æ cron-—É (–Ω–∞–ø—Ä. —Ä–∞–∑ –Ω–∞ –≥–æ–¥–∏–Ω—É)
  sidekiq_options queue: "default", retry: 3

  # –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó: 10,000 –±–∞–ª—ñ–≤ –µ–º—ñ—Å—ñ—ó (growth_points) = 1 SCC (Carbon Coin)
  # –¶–µ –∑–Ω–∞—á–µ–Ω–Ω—è –º–æ–∂–Ω–∞ –±—É–¥–µ –≤–∏–Ω–µ—Å—Ç–∏ –≤ ENV –∞–±–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –û—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó
  EMISSION_THRESHOLD = 10_000

  def perform
    Rails.logger.info "‚öñÔ∏è [NAM-≈†ID] –ó–∞–ø—É—Å–∫ –ï–º—ñ—Å—ñ–π–Ω–æ–≥–æ –¶–µ–Ω—Ç—Ä—É. –û—Ü—ñ–Ω–∫–∞ –±–∞–ª–∞–Ω—Å—ñ–≤..."

    # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ find_each (–±–∞—Ç—á–∏–Ω–≥ –Ω–∞ —Ä—ñ–≤–Ω—ñ SQL) –¥–ª—è –Ω—É–ª—å–æ–≤–æ–≥–æ –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è RAM
    # –®—É–∫–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ —Ç—ñ –≥–∞–º–∞–Ω—Ü—ñ, –¥–µ –±–∞–ª–∞–Ω—Å –¥–æ—Å—è–≥ –∞–±–æ –ø–µ—Ä–µ–≤–∏—â–∏–≤ –ø–æ—Ä—ñ–≥
    Wallet.where("balance >= ?", EMISSION_THRESHOLD).find_each do |wallet|
      evaluate_wallet(wallet)
    end

    Rails.logger.info "‚úÖ [NAM-≈†ID] –ï–º—ñ—Å—ñ–π–Ω–∏–π —Ü–∏–∫–ª –∑–∞–≤–µ—Ä—à–µ–Ω–æ."
  end

  private

  def evaluate_wallet(wallet)
    # –¢–†–ê–ù–ó–ê–ö–¶–Ü–ô–ù–Ü–°–¢–¨ (–ê–±—Å–æ–ª—é—Ç–Ω–∞ –Ü—Å—Ç–∏–Ω–∞):
    # –ú–∏ –Ω–µ –º–æ–∂–µ–º–æ —Å–ø–∏—Å–∞—Ç–∏ –±–∞–ª–∏ –∑ –¥–µ—Ä–µ–≤–∞, —è–∫—â–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –Ω–µ –∑–∞–ø–∏—Å–∞–ª–∞—Å—å —É –±–∞–∑—É.
    ActiveRecord::Base.transaction do
      # –†–∞—Ö—É—î–º–æ, —Å–∫—ñ–ª—å–∫–∏ —Ç–æ–∫–µ–Ω—ñ–≤ –¥–µ—Ä–µ–≤–æ –∑–∞—Å–ª—É–∂–∏–ª–æ (—Ü—ñ–ª–æ—á–∏—Å–µ–ª—å–Ω–µ –¥—ñ–ª–µ–Ω–Ω—è)
      tokens_to_mint = wallet.balance / EMISSION_THRESHOLD
      points_to_burn = tokens_to_mint * EMISSION_THRESHOLD

      # 1. –í—ñ–¥–Ω—ñ–º–∞—î–º–æ –±–∞–ª–∏ (–ö–µ–Ω–æ–∑–∏—Å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å—É)
      wallet.update!(balance: wallet.balance - points_to_burn)

      # 2. –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–∞–º—ñ—Ä (–î–µ–∫—Ä–µ—Ç) –¥–ª—è –±–ª–æ–∫—á–µ–π–Ω—É
      tx = BlockchainTransaction.create!(
        wallet: wallet,
        amount: tokens_to_mint,
        token_type: :carbon_coin, # Silken Carbon Coin
        status: :pending,
        notes: "–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –µ–º—ñ—Å—ñ—è. –ö–æ–Ω–≤–µ—Ä—Ç–æ–≤–∞–Ω–æ #{points_to_burn} –±–∞–ª—ñ–≤ —Ä–æ—Å—Ç—É."
      )

      # 3. –ü–µ—Ä–µ–¥–∞—î–º–æ —É Web3 —á–µ—Ä–≥—É –¥–ª—è —Ñ—ñ–∑–∏—á–Ω–æ–≥–æ –º—ñ–Ω—Ç–∏–Ω–≥—É (–Ω–∞—à —ñ–¥–µ–∞–ª—å–Ω–∏–π –≤–æ—Ä–∫–µ—Ä)
      MintCarbonCoinWorker.perform_async(tx.id)

      Rails.logger.info "üå± [–ï–º—ñ—Å—ñ—è] –î–µ—Ä–µ–≤–æ #{wallet.tree.did} –∫–æ–Ω–≤–µ—Ä—Ç—É–≤–∞–ª–æ #{points_to_burn} –±–∞–ª—ñ–≤ —É #{tokens_to_mint} SCC. –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è ##{tx.id}."
    end
  rescue StandardError => e
    Rails.logger.error "üõë [–ï–º—ñ—Å—ñ—è] –ó–±—ñ–π –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó –¥–ª—è –≥–∞–º–∞–Ω—Ü—è #{wallet.id}: #{e.message}"
    # –Ø–∫—â–æ –∑ –æ–¥–Ω–∏–º –≥–∞–º–∞–Ω—Ü–µ–º —Å—Ç–∞–ª–∞—Å—å –±–∞–∑–∞-–¥–∞–Ω–∏—Ö-–ø–æ–º–∏–ª–∫–∞, –º–∏ –ª–æ–≥—É—î–º–æ —ó—ó —ñ –π–¥–µ–º–æ –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ,
    # –Ω–µ –≤–±–∏–≤–∞—é—á–∏ –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –¥–ª—è –ª—ñ—Å—É.
  end
end
