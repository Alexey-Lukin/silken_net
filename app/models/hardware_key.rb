# frozen_string_literal: true

class HardwareKey < ApplicationRecord
  # =========================================================================
  # Ð‘Ð•Ð—ÐŸÐ•ÐšÐ Ð”ÐÐÐ˜Ð¥ (ActiveRecord Encryption)
  # =========================================================================
  # ÐšÐ»ÑŽÑ‡Ñ– ÑˆÐ¸Ñ„Ñ€ÑƒÑŽÑ‚ÑŒÑÑ Ð¿ÐµÑ€ÐµÐ´ Ð·Ð°Ð¿Ð¸ÑÐ¾Ð¼ Ñƒ Ð‘Ð” Ñ– Ð´ÐµÑˆÐ¸Ñ„Ñ€ÑƒÑŽÑ‚ÑŒÑÑ Ð¿Ñ€Ð¾Ð·Ð¾Ñ€Ð¾ Ð´Ð»Ñ ÐºÐ¾Ð´Ñƒ.
  # Ð¯ÐºÑ‰Ð¾ Ñ…Ð°ÐºÐµÑ€ Ð²ÐºÑ€Ð°Ð´Ðµ Ð´Ð°Ð¼Ð¿ Ð±Ð°Ð·Ð¸, Ð²Ñ–Ð½ Ð¿Ð¾Ð±Ð°Ñ‡Ð¸Ñ‚ÑŒ Ð»Ð¸ÑˆÐµ ÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð³Ñ€Ð°Ñ„Ñ–Ñ‡Ð½Ðµ ÑÐ¼Ñ–Ñ‚Ñ‚Ñ.
  encrypts :aes_key_hex, deterministic: true

  # --- Ð’ÐÐ›Ð†Ð”ÐÐ¦Ð†Ð‡ ---
  # device_uid: HEX-Ñ€ÑÐ´Ð¾Ðº (Ð½Ð°Ð¿Ñ€. "8F2A91C3" Ð´Ð»Ñ Ð¡Ð¾Ð»Ð´Ð°Ñ‚Ð° Ð°Ð±Ð¾ UID ÐšÐ¾Ñ€Ð¾Ð»ÐµÐ²Ð¸)
  validates :device_uid, presence: true, uniqueness: true
  
  # Ð¡Ñ‚Ñ€Ð¾Ð³Ð¾ 32 Ð±Ð°Ð¹Ñ‚Ð¸ (64 HEX ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¸) Ð´Ð»Ñ AES-256
  validates :aes_key_hex, presence: true, length: { is: 64 } 

  # =========================================================================
  # ÐšÐ Ð˜ÐŸÐ¢ÐžÐ“Ð ÐÐ¤Ð†Ð§ÐÐ† ÐœÐ•Ð¢ÐžÐ”Ð˜
  # =========================================================================

  # ÐŸÐµÑ€ÐµÑ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ HEX-Ñ€ÑÐ´ÐºÐ° Ð½Ð° ÑÐ¸Ñ€Ð¸Ð¹ Ð±Ñ–Ð½Ð°Ñ€Ð½Ð¸Ðº Ð´Ð»Ñ OpenSSL (ECB)
  def binary_key
    [aes_key_hex].pack("H*")
  end

  # Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ñ–Ñ Ð½Ð¾Ð²Ð¾Ð³Ð¾ ÐºÐ»ÑŽÑ‡Ð° (Ð²Ð¸ÐºÐ»Ð¸ÐºÐ°Ñ”Ñ‚ÑŒÑÑ Ð¿Ñ€Ð¸ Ñ„Ð°Ð±Ñ€Ð¸ÐºÐ°Ñ†Ñ–Ñ— Ð¡Ð¾Ð»Ð´Ð°Ñ‚Ð°/ÐšÐ¾Ñ€Ð¾Ð»ÐµÐ²Ð¸)
  def self.generate_for(device_uid)
    create!(
      device_uid: device_uid.to_s.upcase,
      aes_key_hex: SecureRandom.hex(32).upcase
    )
  end

  # [ÐÐžÐ’Ð•]: ÐœÐµÑ‚Ð¾Ð´ Ñ€Ð¾Ñ‚Ð°Ñ†Ñ–Ñ— ÐºÐ»ÑŽÑ‡Ð° (Over-The-Air Key Update)
  # Ð¯ÐºÑ‰Ð¾ ÐšÐ¾Ñ€Ð¾Ð»ÐµÐ²Ð° Ð°Ð±Ð¾ Ð¡Ð¾Ð»Ð´Ð°Ñ‚ Ð±ÑƒÐ»Ð¸ ÑÐºÐ¾Ð¼Ð¿Ñ€Ð¾Ð¼ÐµÑ‚Ð¾Ð²Ð°Ð½Ñ– (tamper_detected)
  def rotate_key!
    new_key = SecureRandom.hex(32).upcase
    update!(aes_key_hex: new_key)
    Rails.logger.warn "ðŸ” [CRYPTO] ÐšÐ»ÑŽÑ‡ Ð´Ð»Ñ Ð¿Ñ€Ð¸ÑÑ‚Ñ€Ð¾ÑŽ #{device_uid} Ð±ÑƒÐ»Ð¾ Ð¿Ñ€Ð¸Ð¼ÑƒÑÐ¾Ð²Ð¾ Ñ€Ð¾Ñ‚Ð¾Ð²Ð°Ð½Ð¾."
    new_key
  end
end
