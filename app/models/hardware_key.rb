# frozen_string_literal: true

class HardwareKey < ApplicationRecord
  # =========================================================================
  # –ë–ï–ó–ü–ï–ö–ê –î–ê–ù–ò–• (ActiveRecord Encryption)
  # =========================================================================
  # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ non-deterministic —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è (–Ω–∞–π–≤–∏—â–∏–π —Ä—ñ–≤–µ–Ω—å –±–µ–∑–ø–µ–∫–∏).
  # –ö–ª—é—á—ñ –¥–µ—à–∏—Ñ—Ä—É—é—Ç—å—Å—è –ø—Ä–æ–∑–æ—Ä–æ –ø—Ä–∏ –∑–≤–µ—Ä–Ω–µ–Ω–Ω—ñ.
  encrypts :aes_key_hex

  # --- –ù–û–†–ú–ê–õ–Ü–ó–ê–¶–Ü–Ø ---
  # –ì–∞—Ä–∞–Ω—Ç—É—î–º–æ, —â–æ UID –∑–∞–≤–∂–¥–∏ –≤ –æ–¥–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—ñ –¥–ª—è —É–Ω–∏–∫–Ω–µ–Ω–Ω—è –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤
  normalizes :device_uid, with: ->(uid) { uid.to_s.strip.upcase }

  # --- –í–ê–õ–Ü–î–ê–¶–Ü–á ---
  validates :device_uid, presence: true, uniqueness: true
  
  # –°—Ç—Ä–æ–≥–æ 64 HEX —Å–∏–º–≤–æ–ª–∏ = 32 –±–∞–π—Ç–∏ = AES-256
  # –î–æ–¥–∞—î–º–æ —Ñ–æ—Ä–º–∞—Ç HEX –¥–ª—è –≤–ø–µ–≤–Ω–µ–Ω–æ—Å—Ç—ñ
  validates :aes_key_hex, presence: true, 
                          length: { is: 64 }, 
                          format: { with: /\A[0-9A-F]+\z/i }

  # =========================================================================
  # –ö–†–ò–ü–¢–û–ì–†–ê–§–Ü–ß–ù–Ü –ú–ï–¢–û–î–ò
  # =========================================================================

  # –ü–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è HEX –Ω–∞ —Å–∏—Ä—ñ –±–∞–π—Ç–∏ –¥–ª—è OpenSSL / CoapClient
  # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –º–µ–º–æ—ñ–∑–∞—Ü—ñ—é –¥–ª—è –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ
  def binary_key
    @binary_key ||= [aes_key_hex].pack("H*")
  end

  # –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –Ω–æ–≤–æ–≥–æ –∫–ª—é—á–∞ (Provisioning)
  # –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–æ –∑ HardwareKeyService
  def self.generate_for(device_uid)
    create!(
      device_uid: device_uid,
      aes_key_hex: SecureRandom.hex(32).upcase
    )
  end

  # [–°–ò–ù–•–†–û–ù–Ü–ó–û–í–ê–ù–û]: –†–æ—Ç–∞—Ü—ñ—è –∫–ª—é—á–∞ (OTA Key Update)
  # –ü–æ–≤–µ—Ä—Ç–∞—î —Å–∏—Ä–∏–π –±—ñ–Ω–∞—Ä–Ω–∏–π –∫–ª—é—á –¥–ª—è –Ω–µ–≥–∞–π–Ω–æ—ó –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ —á–µ—Ä–µ–∑ CoapClient
  def rotate_key!
    new_key_hex = SecureRandom.hex(32).upcase
    
    transaction do
      update!(aes_key_hex: new_key_hex)
      # –û—á–∏—â—É—î–º–æ –∫–µ—à–æ–≤–∞–Ω–∏–π –±—ñ–Ω–∞—Ä–Ω–∏–π –∫–ª—é—á
      @binary_key = nil
      
      # –°—Ç–≤–æ—Ä—é—î–º–æ –∑–∞–ø–∏—Å –ø—Ä–æ –ø–æ–¥—ñ—é –±–µ–∑–ø–µ–∫–∏
      Rails.logger.warn "üîê [Zero-Trust] –ö–ª—é—á –¥–ª—è –ø—Ä–∏—Å—Ç—Ä–æ—é #{device_uid} —Ä–æ—Ç–æ–≤–∞–Ω–æ. –ü–æ–ø–µ—Ä–µ–¥–Ω—è –≤–µ—Ä—Å—ñ—è –∞–Ω—É–ª—å–æ–≤–∞–Ω–∞."
    end
    
    binary_key
  end
end
